---
title: "Data from: Success despite the stress- violet-green swallows increase glucocorticoids and maintain reproductive output despite experimental increases in flight costs"
author: Jeff Walker
date: '2018-05-07'
slug: data-from-success-despite-the-stress-violet-green-swallows-increase-glucocorticoids-and-maintain-reproductive-output-despite-experimental-increases-in-flight-costs
categories: []
tags:
  - ecology
  - experiment
  - physiology
subtitle: ''
---
```{r prep, echo=FALSE, message=FALSE}
library(knitr)
library(readxl)
library(ggplot2)
library(data.table)
library(lme4)
library(lmerTest)

base_path <- "../data" #knitr
#base_path <- "content/data"  # console
folder <- '2018-05-07-data-from-success-despite-the-stress'
```

# Sources
Rivers JW, Newberry GN, Schwarz CJ, Ardia DR (2017) Success despite the stress: violet-green swallows increase glucocorticoids and maintain reproductive output despite experimental increases in flight costs. Functional Ecology 31(1): 235-244. https://doi.org/10.1111/1365-2435.12719 [[Google Scholar](https://scholar.google.com/scholar?hl=en&as_sdt=0%2C20&q=%22Success+despite+the+stress%3A+violet‐green+swallows+increase+glucocorticoids+and+maintain+reproductive+output+despite+experimental+increases+in+flight+costs%22&btnG=){target="_blank"}]

Data source: [https://datadryad.org/resource/doi:10.5061/dryad.3bc3s](https://datadryad.org/resource/doi:10.5061/dryad.3bc3s){target="_blank"}

# Background
xxx

# Data
```{r}
fn <- 'RiversetalVGSWhandicappingRawData.xls'
file_path <- paste(base_path, folder, fn, sep='/')
bird <- data.table(read_excel(file_path, sheet = 'Tab3 "a8"'))
bird[, Treatment:=factor(Treatment)]
bird[, Capture_Period:=factor(Nestling_Age)]
bird_wide <- dcast(bird,  Year + Treatment + BandNo + DOY_Initiation + day3mass ~ Capture_Period, value.var=c('Mass','Time'))
bird_wide[, dMass:=Mass_13 - Mass_3]

```

# Reproducibility
## Body Mass
>We found that female body mass significantly decreased between the two capture periods (F1,14.7 = 48.9, P < 0 001; Fig. 2b), but we did not detect a significant effect of either treatment (F2,23 = 1.9, P = 0.173) or a treatment x capture period interaction (F2,15 = 2.5, P = 0.118).

```{r fig2b, fig.cap="Reproduced Fig. 2b"}
# capture period == nestling_age
gg <- ggplot(data=bird, aes(x=Treatment, y=Mass, fill=Capture_Period)) +
  geom_boxplot()
gg
fit <- lmer(Mass ~ Treatment*Capture_Period + (1|BandNo), data=bird)
kable(as.data.frame(anova(fit, ddf="Kenward-Roger")), digits=3)
```

> We found that female body mass significantly decreased between the two capture periods (F1,14.7 = 48.9, P < 0.001; Fig. 2b), but we did not detect a significant effect of either treatment (F2,23 = 1.9, P = 0.173) or a treatment x capture period interaction (F2,15 = 2 5, P = 0.118). The mean decrease in body mass between capture periods was significant for females in the control treatment [b = -0.95 (95% CI:  1.75,  0.14), t1,16 = 3.8, P = 0 017] as well as both handicapping treatments [light clipping: b = -1.07 (95% CI:  1.88,  0.26), t1,15 3 = 4.3, P = 0.007; heavy clipping: b = -2.12 (95% CI:  3.67,  0.58), t1,14 3 = 4.5, P = 0.005; Fig. 2b]. However, the magnitude of decrease in mean body mass of females in the light and heavy clipping treatments was 1.29X (95% CI: 0.6, 2.3) and 2.29X (95% CI: 1.2, 4.5) greater, respectively, that of females in the control treatment.

```{r fib2b_change}
# look at coefficients of lmm in addition to the ANOVA above
b_table <- coefficients(summary(fit))
b <- b_table[, "Estimate"]
kable(b_table, digits=3)

# how many X greater was the reduction (this is a confusing way to report)
b['Treatment2_4Fclip:Capture_Period13']/b['Capture_Period13']
b['Treatment3_8Fclip:Capture_Period13']/b['Capture_Period13']
```
Or, 1.13X and 2.23X more reduction

# Red Flags
## Adjustment for baseline when comparing change in mass
Note the inconsistency between the report of 2.29X greater reduction in mass with CI that does not cover 1.0 and the ANOVA table interaction row (both are different ways of looking at the same thing). Fig 2b shows effectively zero effect of treatment for post-treatment measure. The expectation is zero if there is no effect, and the data are very consistent with this. But there is a big difference in pre-treatment mass among levels (again, the expectation is zero with randomized treatment assignment). So this might be a good example of pre-post bias in the estimates of 1.29X and 2.29X greater reduction in mass. [The expectation for these estimates is not 1.0 conditional on pre-treatment mass](https://www.middleprofessor.com/files/quasipubs/change_scores.html).

Why might? Because the interaction effects of the LMM should adjust for baseline. This should be explored. I compare the results with an ANCOVA using baseline mass as a covariate.

Why might pre-treatment control mass be unusually low or pre-treatment 8-clip mass be unusually high? This could simply be a function of when the birds were weighed, since bird mass oscillates during the day.

```{r fig2bAncova, fig.cap="ANCOVA style plot. blah blah blah"}

# change in mass
gg <- ggplot(data=bird_wide, aes(x=day3mass, y=dMass, color=Treatment)) +
  geom_point()
gg

fit2 <- lm(dMass ~ Mass_3 + Treatment, data=bird_wide)
coefficients(summary(fit2))
```

These results are inconsistent with the LMM where the decrease in mass is actually less for the 4-clip treatment.

```{r fig2b_explore}
# sample size
ycols <- c('Treatment', 'day3mass', 'dMass')
bird_wide[!is.na(dMass), .(N=.N), by=Treatment]

```

Look at their fig 2b which reports sample sizes for pre and post measures. The n drops in all post measures. The ANCOVA only analyzes birds with both pre and post measures so is using less data.
