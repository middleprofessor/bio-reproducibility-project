---
title: 'Data from: Response of bluebunch wheatgrass to invasion differences in competitive
  ability among invader-experienced and naïve populations'
author: Jeff Walker
date: '2019-03-06'
slug: data-from-response-of-bluebunch-wheatgrass-to-invasion-differences-in-competitive-ability-among-invader-experienced-and-naïve-populations
categories: []
tags:
  - R
  - fixed effect nested ANOVA
  - unbalanced ANOVA
  - Anova
  - drop1
  - fake data
subtitle: ''
output:
  blogdown::html_page:
    toc: true
---


<div id="TOC">
<ul>
<li><a href="#sources">Sources</a></li>
<li><a href="#summary">Summary</a></li>
<li><a href="#caveats">Caveats</a></li>
<li><a href="#setup">Setup</a></li>
<li><a href="#import">Import</a></li>
<li><a href="#reproducibility">Reproducibility</a><ul>
<li><a href="#seedling">3.1.1 Seedling</a></li>
<li><a href="#table-1">Table 1</a><ul>
<li><a href="#methods">Methods</a></li>
<li><a href="#check-on-balance">Check on balance</a></li>
<li><a href="#the-model-is-unclear">The model is unclear</a></li>
<li><a href="#table-1published">Table 1–published</a></li>
<li><a href="#table-1---repro">Table 1 - repro</a></li>
</ul></li>
<li><a href="#figure-1">Figure 1</a><ul>
<li><a href="#fig-1-published">Fig 1 – published</a></li>
<li><a href="#fig-1-repro">Fig 1 – repro</a></li>
</ul></li>
</ul></li>
<li><a href="#statistical-red-flags">Statistical red flags</a></li>
</ul>
</div>

<div id="sources" class="section level1">
<h1>Sources</h1>
<p>Gibson A, Nelson CR, Atwater DZ (2018) Response of bluebunch wheatgrass to invasion: Differences in competitive ability among invader-experienced and invader-naïve populations. Functional Ecology 32(7): 1857-1866. <a href="https://doi.org/10.1111/1365-2435.13090" class="uri">https://doi.org/10.1111/1365-2435.13090</a></p>
<p>Gibson AL, Nelson CR, Atwater DZ (2018) Data from: Response of bluebunch wheatgrass to invasion: differences in competitive ability among invader-experienced and naïve populations. Dryad Digital Repository. <a href="https://doi.org/10.5061/dryad.j75g369" class="uri">https://doi.org/10.5061/dryad.j75g369</a></p>
</div>
<div id="summary" class="section level1">
<h1>Summary</h1>
<ol style="list-style-type: decimal">
<li>test</li>
<li></li>
<li></li>
</ol>
</div>
<div id="caveats" class="section level1">
<h1>Caveats</h1>
<p>Failure to reproduce or partial reproducibility might be an error in my coding, or my misunderstanding of the author’s methods, or my lack of knowledge of statistics generally or the R functions that I use more specifically.</p>
</div>
<div id="setup" class="section level1">
<h1>Setup</h1>
<pre class="r"><code>library(ggplot2)
library(readxl)
library(data.table)
library(emmeans)
library(nlme)
library(lmerTest)
library(car)
library(doBy)
library(plyr)
library(cowplot)</code></pre>
<pre class="r"><code>data_folder &lt;- &quot;../data&quot;
folder &lt;- &quot;Data from Response of bluebunch wheatgrass to invasion- differences in competitive ability among invader-experienced and naïve populations&quot;

# images need to be moved to /static/images/data from.../image.png
knitr_path &lt;- FALSE # run = TRUE to debug

source(&quot;../R/clean_label.R&quot;) # bookdown</code></pre>
</div>
<div id="import" class="section level1">
<h1>Import</h1>
<pre class="r"><code>fn &lt;- &quot;Gibson_invasion_response_data.xlsx&quot;
file_path &lt;- paste(data_folder, folder, fn, sep=&quot;/&quot;)

sheet_i &lt;- &quot;Germination&quot;
exp1 &lt;- data.table(read_excel(file_path, sheet=sheet_i))
colnames(exp1) &lt;- clean_label(colnames(exp1))
setnames(exp1, &quot;Type&quot;, &quot;Experience&quot;)

sheet_i &lt;- &quot;Traits&quot;
exp2 &lt;- data.table(read_excel(file_path, sheet=sheet_i, na=&quot;x&quot;))
colnames(exp2) &lt;- clean_label(colnames(exp2))
exp2[, Treatment:=factor(Treatment)]
exp2[, Experience:=factor(Population_Type)]
exp2[, Stage:=ifelse(as.character(Date)==&quot;2012-04-30&quot;,&quot;Seedling&quot;, &quot;Juvenile&quot;)]
exp2[, Exp_Pop:=factor(paste(Experience,Population,sep=&quot;.&quot;))]</code></pre>
</div>
<div id="reproducibility" class="section level1">
<h1>Reproducibility</h1>
<div id="seedling" class="section level2">
<h2>3.1.1 Seedling</h2>
<blockquote>
<p>There was, however, a significant effect of experience type on week-1 rates of germination (F(2, 26) = 9.18, p &lt; .001)</p>
</blockquote>
<pre class="r"><code>con3 &lt;- list(Treatment=contr.sum, Experience=contr.sum) # change the contrasts coding for the model matrix

# fit.full &lt;- lm(Week_1 ~ Treatment*Experience, data=exp1, contrasts=con3)
# Anova(fit.full, type=&quot;3&quot;)

# 26 residual df suggests either this was one-way anova with something removed or an additive model
fit.add &lt;- lm(Week_1 ~ Treatment + Experience, data=exp1, contrasts=con3)
Anova(fit.add, type=&quot;3&quot;) # replicates</code></pre>
<pre><code>## Anova Table (Type III tests)
## 
## Response: Week_1
##             Sum Sq Df F value    Pr(&gt;F)    
## (Intercept) 5212.5  1 63.6986 1.849e-08 ***
## Treatment      0.0  1  0.0000 1.0000000    
## Experience  1502.3  2  9.1791 0.0009638 ***
## Residuals   2127.6 26                      
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<pre class="r"><code># fit.one &lt;- lm(Week_1 ~ Experience, data=exp1[Population!=&quot;Ana&quot;])
# anova(fit.one) # obviously cannot be it given Ana is in the posthoc</code></pre>
<p><span style="color:red">Reproduces using additive model (not specified in methods)</span></p>
<blockquote>
<p>Post hoc tests showed that differences in germination existed between Anatone and the wild populations, but not between IE and IN populations (p = .95). Anatone had 98% fewer week-1 germinants than either IE (difference = 27.8 germinants, p = &lt;.001) or IN populations (difference = 28.7 germinants, p &lt; .001).</p>
</blockquote>
<pre class="r"><code>fit.emm &lt;- emmeans(fit.add, specs=c(&quot;Experience&quot;))
# Tukey HSD
contrast(fit.emm, method=&quot;revpairwise&quot;)</code></pre>
<pre><code>##  contrast estimate   SE df t.ratio p.value
##  E - C      27.833 6.91 26 4.029   0.0012 
##  N - C      28.688 6.78 26 4.228   0.0007 
##  N - E       0.854 3.45 26 0.247   0.9669 
## 
## Results are averaged over the levels of: Treatment 
## P value adjustment: tukey method for comparing a family of 3 estimates</code></pre>
<pre class="r"><code># no adjustment
# contrast(fit.emm, method=&quot;revpairwise&quot;, adjust=&quot;none&quot;)</code></pre>
<p><span style="color:red">There are slight differences in Tukey post-hoc.</span></p>
<blockquote>
<p>There was no significant effect of competition treatment on week-1 germination (F(1, 26) = 0.002, p = .96).</p>
</blockquote>
<p><span style="color:red">Very slight differences (See ANOVA table above) not sure why..</span></p>
</div>
<div id="table-1" class="section level2">
<h2>Table 1</h2>
<div id="methods" class="section level3">
<h3>Methods</h3>
<blockquote>
<p>Next, we assessed trait variation among populations of the same experience type, between invader experience groups (IE and IN) and between treatments using general linear contrasts with population as a fixed factor nested in experience type and with separate models for each response variable (length of longest leaf, number of leaves, total biomass, shoot biomass, root biomass and root:shoot ratio) at each growth phase (seedling and juvenile); models allowed for unequal variance by population type (Pinheiro, Bates, DebRoy, Sarkar, &amp; Team, 2012). Population was nested in experience type because each population was either IE or IN. Anatone was excluded from this analysis. We excluded four native populations from seedling trait analysis and three from juvenile trait analysis because there were not enough plants available from treatment pots.</p>
</blockquote>
<p>Two issues for reproducibility: 1) the model is not clear (see below) and 2) The reported sample sizes are smaller than in the provided Excel file and I cannot details on which cases were excluded.</p>
</div>
<div id="check-on-balance" class="section level3">
<h3>Check on balance</h3>
<pre class="r"><code>exp2.b &lt;- exp2[!is.na(n_Leaves) &amp; Population!=&quot;Ana&quot;,]
counts &lt;- exp2.b[, .(N=.N), by=.(Treatment, Experience, Population, Stage, Exp_Pop)]
exp2.b &lt;- merge(exp2.b, counts, by=c(&quot;Treatment&quot;, &quot;Experience&quot;, &quot;Population&quot;, &quot;Stage&quot;, &quot;Exp_Pop&quot;))</code></pre>
<p>The data are unbalanced at two levels: 1) Different cell sizes in the Treatment x Experience table. There are 8 “N” popuilations but only 6 “E” populations. 2) Some populations, which is the nested factor but also determine E, are missing in the “T” level of Treatment.</p>
<pre class="r"><code>counts[, .(N=.N), by=.(Stage, Treatment, Experience)]</code></pre>
<pre><code>##       Stage Treatment Experience N
## 1: Seedling         C          E 6
## 2: Seedling         T          E 4
## 3: Seedling         C          N 8
## 4: Seedling         T          N 7
## 5: Juvenile         C          E 6
## 6: Juvenile         C          N 8
## 7: Juvenile         T          E 6
## 8: Juvenile         T          N 7</code></pre>
<pre class="r"><code>counts2 &lt;- counts[, .(N=.N), by=.(Stage, Population, Treatment)]
counts2[, .(N=.N), by=.(Stage, Treatment)]</code></pre>
<pre><code>##       Stage Treatment  N
## 1: Seedling         C 14
## 2: Seedling         T 11
## 3: Juvenile         C 14
## 4: Juvenile         T 13</code></pre>
<pre class="r"><code># change eval to TRUE to see these views
counts2[, .(N=.N), by=.(Stage, Population)]
unique(counts2[Treatment==&quot;C&quot; &amp; Stage==&quot;Seedling&quot;, Population])
unique(counts2[Treatment==&quot;T&quot; &amp; Stage==&quot;Seedling&quot;, Population])
sum(counts[Stage==&quot;Seedling&quot;, N])
counts[, .(N=sum(N)), by=Stage]</code></pre>
</div>
<div id="the-model-is-unclear" class="section level3">
<h3>The model is unclear</h3>
<p>The authors cite the nlme package but do not specify any random effect and the ANOVA table suggests only fixed effects (because what other factor do they have that could be random?). Perhaps they used gls() to model unequal variances with Population as both a fixed effect and as the weights for heterogenous variances?. An issue with the data even for a complete fixed effects model <code>y ~ Treatment*Experience + Experience:Population</code>, which is a fixed Population nested within Experience, has a singular XtX^-1 covariance matrix, which creates problems: 1) car type III SS doesn’t run, 2) drop1 generates a table with the df=0 for Experience.</p>
<p>Here I simulated data to see what works. Some notes 1. def: crossed coding is the same set of labels for the levels of the nested factor across levels of the higher factor even though these labels do not have the same meaning across the levels of the higher level factor. E.g. B is nested within A and the levels of B are pop1, pop2, pop3, pop4, pop5 in all levels of A. 2. def: nested coding uses different labels for the levels of the nested factor across levels of the higher factor. E.g. B is nested within A and the levels of B are pop1-pop5 in the CN level of A and pop6-pop10 in the TR level of A. 3. <strong>If the nested factor is fixed, it has to be coded using crossed coding to work in <code>car::Anova</code></strong>. Nested coding partly works using <code>drop1</code>. it gives zero df for the outermost factor. Note the nested coding works in JMP. 4. If the data are unbalanced because the levels of factor A have different numbers of groups (levels) then type III ANOVA using car fails. Type II works using “model comparison”. drop1 works except it assigns 0 df to the outer factor.</p>
<pre class="r"><code>xcols &lt;- c(&quot;Treatment&quot;, &quot;Experience&quot;, &quot;Stage&quot;, &quot;Population&quot;, &quot;Exp_Pop&quot;)
ycols &lt;- c(&quot;Longest_leaf&quot;, &quot;n_Leaves&quot;, &quot;Biomass&quot;, &quot;Shoot_biomass&quot;, &quot;Root_biomass&quot;, &quot;Root.shoot_ratio&quot;)

con3 &lt;- list(Treatment=contr.sum, Experience=contr.sum) # change the contrasts coding for the model matrix

f_table &lt;- list()
for(stage_j in c(&quot;Seedling&quot;, &quot;Juvenile&quot;)){
  for(y in ycols){
    subdata &lt;- exp2.b[Stage==stage_j &amp; N &gt; 1, .SD, .SDcols=c(xcols, y)]
    # recode Populations to 1:n_pop; this is only way to analyze as fixed using aov
    # subdata[, Population2:=Population]
    popsE &lt;- unique(subdata[Experience==&quot;E&quot;, Population])
    subdata[Population %in% popsE, Population.cross:= mapvalues(Population, from = popsE, to = as.character(1:length(popsE)))]
    popsN &lt;- unique(subdata[Experience==&quot;N&quot;, Population])
    subdata[Population %in% popsN, Population.cross:= mapvalues(Population, from = popsN, to = as.character(1:length(popsN)))]
    subdata[, Population.cross:=factor(Population.cross)]
    
    # the best I can do. I explicitly ordered the terms this way to match table 1
    
    fit3 &lt;- lm(get(y) ~  Treatment + Experience + Population.cross%in%Experience + Treatment:Experience, contrasts=con3, data=subdata)
    table_i &lt;- drop1(fit3, .~., test=&quot;F&quot;) # matches JMP except Experience row
    
    # these do not run because of singular xtxi matrix
    # Anova(fit3, type=&quot;3&quot;)
    # form_i &lt;- formula(paste(y, &quot;~ Treatment*Experience + Population.cross%in%Experience&quot;))
    # fit &lt;- gls(form_i, weights=varIdent(form=~1|Population), data=subdata) # singular
    
    if(y==ycols[1]){
      f_table[[stage_j]] &lt;- data.table(terms=row.names(table_i)[2:5],
                            table_i[2:5, &quot;F value&quot;])
    }else{
      f_table[[stage_j]] &lt;- cbind(f_table[[stage_j]], table_i[2:5, &quot;F value&quot;])
    }
    setnames(f_table[[stage_j]], old=&quot;V2&quot;, new=y)
  }
}</code></pre>
</div>
<div id="table-1published" class="section level3">
<h3>Table 1–published</h3>
<p><img src="/images/Data from Response of bluebunch wheatgrass to invasion- differences in competitive ability among invader-experienced and naïve populations/table1.png" width="400px" /></p>
</div>
<div id="table-1---repro" class="section level3">
<h3>Table 1 - repro</h3>
<table>
<caption><span id="tab:mytable1-seedling">Table 1: </span>Seedling</caption>
<thead>
<tr class="header">
<th align="left">terms</th>
<th align="right">Longest_leaf</th>
<th align="right">n_Leaves</th>
<th align="right">Biomass</th>
<th align="right">Shoot_biomass</th>
<th align="right">Root_biomass</th>
<th align="right">Root.shoot_ratio</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Treatment</td>
<td align="right">1.26</td>
<td align="right">15.84</td>
<td align="right">0.38</td>
<td align="right">1.29</td>
<td align="right">0.13</td>
<td align="right">0.54</td>
</tr>
<tr class="even">
<td align="left">Experience</td>
<td align="right">0.08</td>
<td align="right">0.07</td>
<td align="right">0.26</td>
<td align="right">0.92</td>
<td align="right">0.08</td>
<td align="right">0.00</td>
</tr>
<tr class="odd">
<td align="left">Experience:Population.cross</td>
<td align="right">0.77</td>
<td align="right">1.56</td>
<td align="right">1.44</td>
<td align="right">2.10</td>
<td align="right">2.16</td>
<td align="right">4.29</td>
</tr>
<tr class="even">
<td align="left">Treatment:Experience</td>
<td align="right">0.70</td>
<td align="right">0.75</td>
<td align="right">0.25</td>
<td align="right">0.01</td>
<td align="right">0.43</td>
<td align="right">0.06</td>
</tr>
</tbody>
</table>
<table>
<caption><span id="tab:mytable1-juvenile">Table 2: </span>Juvenile</caption>
<thead>
<tr class="header">
<th align="left">terms</th>
<th align="right">Longest_leaf</th>
<th align="right">n_Leaves</th>
<th align="right">Biomass</th>
<th align="right">Shoot_biomass</th>
<th align="right">Root_biomass</th>
<th align="right">Root.shoot_ratio</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Treatment</td>
<td align="right">0.13</td>
<td align="right">9.62</td>
<td align="right">0.89</td>
<td align="right">1.27</td>
<td align="right">0.31</td>
<td align="right">0.16</td>
</tr>
<tr class="even">
<td align="left">Experience</td>
<td align="right">0.05</td>
<td align="right">1.45</td>
<td align="right">5.06</td>
<td align="right">0.27</td>
<td align="right">7.73</td>
<td align="right">1.00</td>
</tr>
<tr class="odd">
<td align="left">Experience:Population.cross</td>
<td align="right">1.00</td>
<td align="right">3.72</td>
<td align="right">2.34</td>
<td align="right">0.81</td>
<td align="right">3.08</td>
<td align="right">1.37</td>
</tr>
<tr class="even">
<td align="left">Treatment:Experience</td>
<td align="right">1.24</td>
<td align="right">1.54</td>
<td align="right">2.21</td>
<td align="right">1.21</td>
<td align="right">1.77</td>
<td align="right">0.01</td>
</tr>
</tbody>
</table>
<p><span style="color:red">None reproduce. Note that my sample size is bigger than the reported sample size. It’s not clear which cases are excluded from the analyses.</span></p>
<div id="sample-size" class="section level4">
<h4>sample size</h4>
<pre class="r"><code>counts[, .(N=sum(N)), by=Stage]</code></pre>
<pre><code>##       Stage   N
## 1: Seedling 118
## 2: Juvenile 111</code></pre>
</div>
</div>
</div>
<div id="figure-1" class="section level2">
<h2>Figure 1</h2>
<p>The SEs in the figure could be 1) modeled SE (my preference), 2) the raw SE pooling over replicates within Population (complete pool), or 3) the raw SE using the Population means. I compute all these but only plot the complete pooling SEs.</p>
<pre class="r"><code>xcols &lt;- c(&quot;Treatment&quot;, &quot;Experience&quot;, &quot;Stage&quot;, &quot;Population&quot;, &quot;Exp_Pop&quot;)
ycols_seed &lt;- c(&quot;Shoot_biomass&quot;, &quot;n_Leaves&quot;, &quot;Root.shoot_ratio&quot;)
ycols_juv &lt;- c(&quot;n_Leaves&quot;,&quot;Biomass&quot;, &quot;Root_biomass&quot;)

con3 &lt;- list(Treatment=contr.sum, Experience=contr.sum) # change the contrasts coding for the model matrix

gg_list &lt;- list()

for(stage_j in c(&quot;Seedling&quot;, &quot;Juvenile&quot;)){
  if(stage_j==&quot;Seedling&quot;){
    ycols &lt;- ycols_seed}else{
      ycols &lt;- ycols_juv}
  for(y in ycols){
    subdata &lt;- na.omit(exp2.b[Stage==stage_j &amp;
                                N &gt; 1, .SD, .SDcols=c(xcols, y)])
    # recode Populations to 1:n_pop; this is only way to analyze as fixed using aov
    # subdata[, Population2:=Population]
    popsE &lt;- unique(subdata[Experience==&quot;E&quot;, Population])
    subdata[Population %in% popsE, Population.cross:= mapvalues(Population, from = popsE, to = as.character(1:length(popsE)))]
    popsN &lt;- unique(subdata[Experience==&quot;N&quot;, Population])
    subdata[Population %in% popsN, Population.cross:= mapvalues(Population, from = popsN, to = as.character(1:length(popsN)))]
    subdata[, Population.cross:=factor(Population.cross)]
    
    # modeled SE
    fit3 &lt;- lm(get(y) ~  Treatment + Experience + Population.cross%in%Experience + Treatment:Experience, contrasts=con3, data=subdata)
    fit3.emm &lt;- data.table(summary(emmeans(fit3, specs=c(&quot;Treatment&quot;, &quot;Experience&quot;))))
    
    # raw SE (how to deal with nested?)
    # pooled SE (ignore nested structure)
    subdata.pool.SE &lt;- subdata[, .(ybar=mean(get(y)),
                                   SE=sd(get(y))/sqrt(.N)
    ), by=.(Treatment, Experience)]
    # SE of pop means
    # no pool (average replicates within pop)
    subdata.nopool &lt;- subdata[, .(ybar=mean(get(y))
    ), by=.(Treatment, Experience, Population)]
    subdata.nopool.SE &lt;- subdata.nopool[, .(ybar=mean(ybar),
                                            SE=sd(ybar)/sqrt(.N)
    ), by=.(Treatment, Experience)]
    
    # modeled SE
    pd &lt;- position_dodge(0.5)
    gg &lt;- ggplot(data=fit3.emm, aes(x=Treatment, y=emmean, color=Experience, group=Experience)) +
      geom_point(position=pd) +
      geom_line(position=pd) +
      geom_errorbar(aes(min=emmean-SE, max=emmean+SE), position=pd, width=.2) +
      ylab(y) +
      NULL
    #gg
    
    # complete pooling
    gg &lt;- ggplot(data=subdata.pool.SE, aes(x=Treatment, y=ybar, color=Experience, group=Experience, shape=Experience)) +
      geom_point(position=pd) +
      geom_line(position=pd) +
      geom_errorbar(aes(min=ybar-SE, max=ybar+SE), position=pd, width=.2) +
      ylab(y) +
      NULL
    
    label_i &lt;- paste(y, stage_j, sep=&quot;.&quot;)
    gg_list[[label_i]] &lt;- gg
  }
}</code></pre>
<div id="fig-1-published" class="section level3">
<h3>Fig 1 – published</h3>
<p><img src="/images/Data from Response of bluebunch wheatgrass to invasion- differences in competitive ability among invader-experienced and naïve populations/fig1.png" width="400px" /></p>
</div>
<div id="fig-1-repro" class="section level3">
<h3>Fig 1 – repro</h3>
<p><img src="/post/2019-03-06-data-from-response-of-bluebunch-wheatgrass-to-invasion-differences-in-competitive-ability-among-invader-experienced-and-na%C3%AFve-populations_files/figure-html/my-fig1-seedling-1.png" width="600px" /></p>
<p><span style="color:red">While the patterns are similar, none reproduce, but this isn’t surprising given that my sample size is bigger than that in Table 1 (so the authors have excluded data, but I’m not sure which).</span></p>
</div>
</div>
</div>
<div id="statistical-red-flags" class="section level1">
<h1>Statistical red flags</h1>
</div>
