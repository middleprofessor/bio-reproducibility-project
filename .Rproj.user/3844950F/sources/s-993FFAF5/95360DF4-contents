--- 
title: "Elements of Applied Biostatistics"
author: "Jeffrey A. Walker"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
output: bookdown::gitbook
documentclass: book
bibliography: [book.bib, packages.bib]
biblio-style: apalike
link-citations: yes
github-repo: 
description: "A first course in statistical modeling for biology undergraduates."
---

```{r include=FALSE}
# automatically create a bib database for R packages
knitr::write_bib(c(
  .packages(), 'bookdown', 'knitr', 'rmarkdown'
), 'packages.bib')
```

```{r prep, echo=FALSE}
file_path <- "data/"
library(ggplot2)
library(data.table)
library(lme4)
```

# Modeling

We use statistics to learn from data with uncertainty. Traditional introductory textbooks in biostatistics implicitly or explicitly train students and researchers to "discover by p-value" using hypothesis tests (appendix xxx). Over the course of many chapters, the student is trained to use something like a dichotomous key to choose the correct "test" for the data at hand, compute a test statistic for their data, compute a p-value based on the test statistic, and compares the p-value to 0.05. Textbooks typically give very little guidance about what can be concluded if $p < 0.05$ or $p > 0.05$, but many researchers conclude they have discovered something if $p < 0.05$ but found "no effect" if $p > 0.05$.

Researchers learn almost nothing useful from a hypothesis test. If we are investigating the effects of an increasingly acidified ocean on coral growth, $p=0.002$ may be evidence that pH affects growth, but, from everything we know about pH and cell biology, it would be absurd to conclude from any data that ocean acidification does not affect growth. Instead, we want to know the magnitude of the effect and our uncertainty in estimating this magnitude. We can use this magnitude and uncertainty to make predictions about the future of coral reefs, under different scenarios of ocean acidification. We can use the estimated effects and uncertainty to model the consquences of the effects of acidification on coral growth on fish production or carbon cycling.

The "discovery by p-value" strategy, or Null-Hypothesis Significance Testing (NHST), has been criticized by statisticians for many, many decades. Nevertheless, introductory biostatistics textbooks written by both biologists and statisticians continue to organize textbooks around a collection of hypothesis tests, with little emphasis on estimation and uncertainty.

## Linear models
This textbook is an introduction to the analysis of biological data using linear models. Linear models are also the engine behind many hypothesis tests but the emphasis here is estimation and uncertainty instead of test statistics and $p$-values. A modeling view of statistics is also more coherent than a dichotomous key strategy.

To introduce the difference between the modeling strategy and the dichotomous key strategy, I use data from a study that showed that North American red squirrel (*Tamiasciurus hudsonicus*) mothers from Yukon, Alaska produce faster growing pups in years with increased squirrel density (@Dantzer_xxx). Remarkably, the researchers even showed that perceived (but not actual) density results in faster growing pups.

### A model with continuous $X$
To begin to investigate how squirrel density during pregnancy could control the future growth rate of pups, the researchers measured the relationship between local squirrel density (the variable $Density$) and the amount of fecal cortisol metabolites from pregnant mothers (the variable $FCM$). Cortisol is a hormone that is secreted as part of stress response. The researchers were interested in cortisol because it is known that, in mammals, blood cortisol levels in pregnant mothers have numerous effects on offspring long past birth. If increased squirrel density causes increased blood cortisol levels, then we would expect to find a positive relationship between $Density$ and $FCM$.  

```{r continuousX, echo=FALSE, warning=FALSE, fig.cap="A scatterplot of Fecal cortisol matabolites and squirrel density."}
# Dantzer, B., Newman, A.E., Boonstra, R., Palme, R., Boutin, S., Humphries, M.M. and McAdam, A.G., 2013. Density triggers maternal hormones that increase adaptive offspring growth in a wild mammal. Science, p.1235765.
# https://datadryad.org/resource/doi:10.5061/dryad.b3h4q
# data for Fig 3A/Table S4
# 
fn <- paste(file_path,'Dantzer/FCM data dryad.csv',sep='')
feces <- data.table(read.table(fn, sep=',', header=TRUE))
setnames(feces, old=c('FCM.ng.g.dry'), new=c('FCM'))
setnames(feces, old=c('Food.Add.Grid'), new=c('Treatment'))
setnames(feces, old=c('Raw.Squirrel.Density'), new=c('Density'))
feces[,Treatment:=factor(Treatment)]

gg <- ggplot(data=feces, aes(x=Density, y=FCM)) +
  geom_point() +
  geom_smooth(method='lm') +
  xlab("Squirrel Density (squirrels per hectare)") +
  ylab("Fecal Cortisol Metabolites (ng per g dry mass)") +
  theme_minimal()
gg

# simple model
fit <- lm(FCM ~ Density, data=feces)
b_table <- coefficients(summary(fit))

#lmm - replicates! but weird as uses experimental data in this
fit.lmm <- lmer(log(FCM) ~ scaled.days.postconception + Density + (1|Year.Sample.Collected) + (1|Squirrel.ID), data=feces)
b_table.lmm <- coefficients(summary(fit.lmm))

# categorical model as in Table S4 and Figure 3B - replicates!
fit.lmm <- lmer(log(FCM) ~ scaled.days.postconception + Treatment + (1|Year.Sample.Collected) + (1|Squirrel.ID), data=feces)
b_table.lmm <- coefficients(summary(fit.lmm))

# plot with treatment colored
qplot(x=Density, y=log(FCM), color=Treatment, data=feces) + geom_point() + geom_smooth(method='lm')

# this plot suggests that some of treatment effect is due to increased FCM at the same density so a non-density effect of the treatment. This can be partitioned with the followig
fit2.lmm <- lmer(log(FCM) ~ scaled.days.postconception + Density + Treatment + (1|Year.Sample.Collected) + (1|Squirrel.ID), data=feces)
b_table2.lmm <- coefficients(summary(fit2.lmm))
# here the density effect independent of the treatment effect has wide intervals that range from zero to big and positive.

#Table S4, figure 3C - replicates
fn <- paste(file_path,'Dantzer/Table S4 - playback FCM data.csv',sep='')
feces2 <- data.table(read.table(fn, sep=',', header=TRUE))
setnames(feces2, old=c('FCM.ng.g.dry'), new=c('FCM'))
setnames(feces2, old=c('Squirrel.Taglft'), new=c('ID'))
setnames(feces2, old=c('scaled.days.postconception'), new=c('days_pc'))
feces2[,Treatment:=factor(Treatment)]
fit3.lmm <- lmer(log(FCM) ~ days_pc + Treatment + (1|ID), data=feces2)
b_table3.lmm <- coefficients(summary(fit3.lmm))
qplot(x=Treatment, y=log(FCM), data=feces2) + geom_boxplot() + geom_point()

#Table S3 - chickadee
fn <- paste(file_path,'Dantzer/before.playback.fcm.data.csv',sep='')
feces3 <- data.table(read.table(fn, sep=',', header=TRUE))
setnames(feces3, old=c('Raw.FCM.ng.g.dry'), new=c('FCM'))
setnames(feces3, old=c('Squirrel.Taglft'), new=c('ID'))
setnames(feces3, old=c('Days.Post.Conception'), new=c('days_pc'))
feces3[,Treatment:=factor(Treatment)]
fit4.lmm <- lmer(log(FCM) ~ days_pc + Treatment + (1|ID), data=feces3)
b_table4.lmm <- coefficients(summary(fit4.lmm))
qplot(x=Treatment, y=log(FCM), data=feces3) + geom_boxplot() + geom_point()

# combine into single file with three treatment levels (control + chickadee + rattle) and two time levels (before, after)
# note that days_pc is scaled in feces2 but raw in feces3
feces3[, days_pc:=scale(days_pc)]
dt <- merge(feces2[, .SD, .SDcols=c('ID', 'Treatment', 'days_pc', 'FCM')], feces3[, .SD, .SDcols=c('ID', 'Treatment', 'days_pc', 'FCM')], by='ID', all=TRUE)

dt.o <- na.omit(dt)
fit5.lmm <- lmer(log(FCM.x) ~ days_pc.x + Treatment.x + FCM.y + days_pc.y + (1|ID), data=dt.o)
b_table5.lmm <- coefficients(summary(fit5.lmm))

```

The Figure \@ref(fig:squirrel) is a **scatterplot** of $FCM$ (the amount of cortisol metabolites in the feces) and $Density$ (local squirrel density ). Following standard practice, $FCM$ is on the $Y$ axis because we are modeling it as the **dependent** variable and $Density$ is on the $X$ axis because we are modeling it as the **independent** variable. The line through the data is a graphical representation of a linear model fit to the data and the gray cloud around the line is a graphical representation of the uncertainty in the model.

The effect of $Density$ on $FCM$ is the slope of the line in Figure \@ref(fig:squirrel). The equation for this line is 

\begin{equation}
\widehat{FCM} = 736 + 671 Density
(\#eq:regression)
\end{equation}

\widehat{FCM} is the **modeled value** of $FCM$ given some value of $Density$. The symbol over $FCM$ is a carot or "hat" symbol, and $\widehat{FCM}$ is read as "FCM-hat." \widehat{FCM} is more commonly known as a **predicted value** but I prefer modeled value since "modeled" more precisely describes what these are. For any value of $Density$ used in equation \@ref(eq:regression), the resulting value of \widehat{FCM} will be somewhere on the line.^[problem 1xxx] This is what is meant by referring to $FCM$ as the dependent variable -- it's modeled value *depends* on the value of some other variable. It is very important at this point to recognize that this dependence is in the very abstract sense that it is the *modeled* value of $FCM$ that depends on the value of $Density$. This is a statistical or probabilistic dependence. The modeled value can imply a causal dependence under some conditions which we return to in a moment.

The intercept (735.96) and slope (671.14) of the line given in equation \@ref(eq:regression) are the coefficients $b_0$ and $b_1$ of the model

\begin{equation}
\widehat{FCM} = b_0 + b_1 Density
(\#eq:coefficients)
\end{equation}

The slope coefficient $b_1$ is the **modeled effect** of $Density$ on $FCM$. The bigger the value of this coefficient the stronger the modeled effect. The direction of the effect is indicated by the sign of the coefficient. For these data, the coefficient is positive. If the coefficient were negative, the modeled effect would be negative and the modeled $FCM$ woud decrease with increasing $Density$. This negative effect would be represented graphically by a line sloping down and to the right in Figure \@ref(fig:squirrel).^[problem 2xxx]

The coefficients $b_0$ and $b_1$ are sample **estimates** of the **parameters** $\beta_0$ and $\beta_1$ of the model

\begin{equation}
FCM = \beta_0 + \beta_1 Density + \varepsilon
(\#eq:lm)
\end{equation}

The first part ($\beta_0 + \beta_1 Density$) of the right-hand side of model \@ref(eq:lm) is the **expected value** of $FCM$ given some value of $Density$. The second part ($\varepsilon$) is the error, which is simply the difference between the measured and expected value -- "error" does not mean error in the sense of "something that went wrong." The expected value in model \@ref(eq:lm) can be written mathematically as $\textrm{E}[FCM|Density]$, which is read as "the expected value of FCM conditional on Density." An expected value is a long run average -- if we could sample an infinite number of red squirrel populations, then the expected value is the average over all the samples. Importantly, $\textrm{E}[FCM|Density]$ is a **conditional mean**, as indicated by "$|Density$." This is simply the long-run average of $FCM$ if we were to sample lots and lots (an infinite number!) of red squirrel populations, *all with a density equal to some constant value x*.

In this book, a parameter is a **population** or true value. The parameter $\beta_1$ is the true, **probabilistic effect** of $Density$ on $FCM$. $\beta_1$ is a "probabilistic" effect because, numerically, it is a difference in expected values. More specifically, $\beta_1$ in model \@ref(eq:lm) is the difference in expected value of $FCM$ given a one unit difference in $Density$:

\begin{equation}
\beta_1 = \textrm{E}[FCM|Density=x+1] - \textrm{E}[FCM|Density=x]
(\#eq:beta1)
\end{equation}

### A model with categorical $X$

```{r categoricalX, echo=FALSE, warning=FALSE, fig.cap="A scatterplot of Fecal cortisol matabolites and squirrel density."}
# Dantzer, B., Newman, A.E., Boonstra, R., Palme, R., Boutin, S., Humphries, M.M. and McAdam, A.G., 2013. Density triggers maternal hormones that increase adaptive offspring growth in a wild mammal. Science, p.1235765.
# https://datadryad.org/resource/doi:10.5061/dryad.b3h4q
# data for Fig 3A/Table S4
fn <- paste(file_path,'Dantzer/FCM.csv',sep='')
feces <- data.table(read.table(fn, sep=',', header=TRUE))
gg <- ggplot(data=feces, aes(x=Density, y=FCM)) +
  geom_point() +
  geom_smooth(method='lm') +
  xlab("Squirrel Density (squirrels per hectare)") +
  ylab("Fecal Cortisol Metabolites (ng per g dry mass)") +
  theme_minimal()
gg

# simple model
fit <- lm(FCM ~ Density, data=feces)
b_table <- coefficients(summary(fit))

#

```


